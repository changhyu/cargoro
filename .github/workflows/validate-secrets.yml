name: ğŸ” Validate Secrets Configuration

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/**'

jobs:
  validate-secrets:
    name: ğŸ” Validate Required Secrets
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ Check Required Secrets
        run: |
          echo "ğŸ” Validating required secrets configuration..."

          # AWS ì„¤ì • ê²€ì¦
          if [ -z "${{ secrets.AWS_ROLE_ARN }}" ]; then
            echo "âŒ AWS_ROLE_ARN is not set"
            exit 1
          else
            echo "âœ… AWS_ROLE_ARN is configured"
          fi

          # Docker ì„¤ì • ê²€ì¦
          if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "âŒ DOCKER_USERNAME is not set"
            exit 1
          else
            echo "âœ… DOCKER_USERNAME is configured"
          fi

          if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "âŒ DOCKER_PASSWORD is not set"
            exit 1
          else
            echo "âœ… DOCKER_PASSWORD is configured"
          fi

          # Slack ì„¤ì • ê²€ì¦
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "âŒ SLACK_WEBHOOK_URL is not set"
            exit 1
          else
            echo "âœ… SLACK_WEBHOOK_URL is configured"
          fi

          # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ê²€ì¦
          if [ -z "${{ secrets.PROD_DB_HOST }}" ]; then
            echo "âŒ PROD_DB_HOST is not set"
            exit 1
          else
            echo "âœ… PROD_DB_HOST is configured"
          fi

          if [ -z "${{ secrets.STAGING_DB_HOST }}" ]; then
            echo "âŒ STAGING_DB_HOST is not set"
            exit 1
          else
            echo "âœ… STAGING_DB_HOST is configured"
          fi

          # Redis ì„¤ì • ê²€ì¦
          if [ -z "${{ secrets.PROD_REDIS_HOST }}" ]; then
            echo "âŒ PROD_REDIS_HOST is not set"
            exit 1
          else
            echo "âœ… PROD_REDIS_HOST is configured"
          fi

          if [ -z "${{ secrets.STAGING_REDIS_HOST }}" ]; then
            echo "âŒ STAGING_REDIS_HOST is not set"
            exit 1
          else
            echo "âœ… STAGING_REDIS_HOST is configured"
          fi

          echo "ğŸ‰ All required secrets are properly configured!"

  test-aws-connection:
    name: ğŸ”— Test AWS Connection
    runs-on: ubuntu-latest
    needs: validate-secrets

    permissions:
      id-token: write
      contents: read

    steps:
      - name: ğŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: ğŸ§ª Test AWS Access
        run: |
          echo "ğŸ” Testing AWS access..."
          aws sts get-caller-identity
          echo "âœ… AWS connection successful!"

  test-docker-connection:
    name: ğŸ³ Test Docker Hub Connection
    runs-on: ubuntu-latest
    needs: validate-secrets

    steps:
      - name: ğŸ”‘ Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ§ª Test Docker Hub Access
        run: |
          echo "ğŸ” Testing Docker Hub access..."
          docker pull hello-world
          echo "âœ… Docker Hub connection successful!"

  test-slack-notification:
    name: ğŸ“¢ Test Slack Notification
    runs-on: ubuntu-latest
    needs: validate-secrets

    steps:
      - name: ğŸ“¨ Send Test Notification
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "text": "ğŸ§ª CarGoro CI/CD Secrets ì„¤ì • í…ŒìŠ¤íŠ¸ ì™„ë£Œ!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*CarGoro CI/CD Pipeline*\nâœ… ëª¨ë“  GitHub Secretsì´ ì •ìƒì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "í…ŒìŠ¤íŠ¸ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
                    }
                  ]
                }
              ]
            }'
          echo "âœ… Slack notification sent successfully!"
