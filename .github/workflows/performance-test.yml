name: μ„±λ¥ ν…μ¤νΈ

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ν…μ¤νΈ ν™κ²½'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      url:
        description: 'ν…μ¤νΈν•  URL (κΈ°λ³Έκ°’ λ€μ‹  μ‚¬μ©)'
        required: false
        type: string

env:
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  lighthouse-test:
    name: Lighthouse μ„±λ¥ ν…μ¤νΈ
    runs-on: ubuntu-latest
    steps:
      - name: μ†μ¤μ½”λ“ μ²΄ν¬μ•„μ›ƒ
        uses: actions/checkout@v3

      - name: Node.js μ„¤μ •
        uses: actions/setup-node@v3
        with:
          node-version: 18
      
      - name: ν…μ¤νΈ URL κ²°μ •
        id: urls
        run: |
          if [ -n "${{ github.event.inputs.url }}" ]; then
            echo "TEST_URL=${{ github.event.inputs.url }}" >> $GITHUB_ENV
          else
            case "${{ env.ENVIRONMENT }}" in
              development)
                echo "TEST_URL=https://dev.cargoro.com" >> $GITHUB_ENV
                ;;
              staging)
                echo "TEST_URL=https://staging.cargoro.com" >> $GITHUB_ENV
                ;;
              production)
                echo "TEST_URL=https://cargoro.com" >> $GITHUB_ENV
                ;;
            esac
          fi
          
          echo "ν…μ¤νΈ URL: $TEST_URL"
      
      - name: Lighthouse CI μ„¤μΉ
        run: npm install -g @lhci/cli@0.13.x
      
      - name: Lighthouse ν…μ¤νΈ μ‹¤ν–‰
        run: |
          lhci autorun \
            --collect.url=$TEST_URL \
            --collect.numberOfRuns=3 \
            --collect.settings.preset=desktop \
            --upload.target=temporary-public-storage
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: κ²°κ³Ό μ €μ¥
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-results
          path: '.lighthouseci'
          retention-days: 30

  k6-load-test:
    name: k6 λ¶€ν• ν…μ¤νΈ
    runs-on: ubuntu-latest
    steps:
      - name: μ†μ¤μ½”λ“ μ²΄ν¬μ•„μ›ƒ
        uses: actions/checkout@v3
      
      - name: k6 μ„¤μΉ
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6 -y
      
      - name: ν…μ¤νΈ API μ—”λ“ν¬μΈνΈ κ²°μ •
        id: api-url
        run: |
          if [ -n "${{ github.event.inputs.url }}" ]; then
            echo "API_URL=${{ github.event.inputs.url }}" >> $GITHUB_ENV
          else
            case "${{ env.ENVIRONMENT }}" in
              development)
                echo "API_URL=https://api.dev.cargoro.com" >> $GITHUB_ENV
                ;;
              staging)
                echo "API_URL=https://api.staging.cargoro.com" >> $GITHUB_ENV
                ;;
              production)
                echo "API_URL=https://api.cargoro.com" >> $GITHUB_ENV
                ;;
            esac
          fi
          
          echo "API ν…μ¤νΈ URL: $API_URL"
      
      - name: λ¶€ν• ν…μ¤νΈ μ‹¤ν–‰ (API)
        run: |
          k6 run infra/performance/api-load-test.js --out json=results.json --summary-export=summary.json
        env:
          K6_BASE_URL: ${{ env.API_URL }}
      
      - name: κ²°κ³Ό μ €μ¥
        uses: actions/upload-artifact@v3
        with:
          name: k6-load-test-results
          path: |
            results.json
            summary.json
          retention-days: 30
      
      - name: μ”μ•½ λ³΄κ³ μ„ μƒμ„±
        run: |
          echo "## K6 λ¶€ν• ν…μ¤νΈ μ”μ•½" >> $GITHUB_STEP_SUMMARY
          echo "| λ©”νΈλ¦­ | κ°’ |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          
          HTTP_REQ_RATE=$(jq '.metrics.http_reqs.rate' summary.json)
          HTTP_REQ_FAILED=$(jq '.metrics.http_req_failed.values.rate' summary.json)
          HTTP_REQ_DURATION_AVG=$(jq '.metrics.http_req_duration.values.avg' summary.json)
          HTTP_REQ_DURATION_P95=$(jq '.metrics.http_req_duration.values."p(95)"' summary.json)
          
          echo "| μ΄λ‹Ή μ”μ²­ | $HTTP_REQ_RATE |" >> $GITHUB_STEP_SUMMARY
          echo "| μ‹¤ν¨μ¨ | $HTTP_REQ_FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "| ν‰κ·  μ‘λ‹µμ‹κ°„ | $(printf "%.2f" $HTTP_REQ_DURATION_AVG) ms |" >> $GITHUB_STEP_SUMMARY
          echo "| 95% μ‘λ‹µμ‹κ°„ | $(printf "%.2f" $HTTP_REQ_DURATION_P95) ms |" >> $GITHUB_STEP_SUMMARY

  webpagetest:
    name: WebPageTest λ¶„μ„
    runs-on: ubuntu-latest
    steps:
      - name: μ†μ¤μ½”λ“ μ²΄ν¬μ•„μ›ƒ
        uses: actions/checkout@v3
      
      - name: Node.js μ„¤μ •
        uses: actions/setup-node@v3
        with:
          node-version: 18
      
      - name: WebPageTest CLI μ„¤μΉ
        run: npm install -g webpagetest-api
      
      - name: ν…μ¤νΈ URL κ²°μ •
        id: webpage-url
        run: |
          if [ -n "${{ github.event.inputs.url }}" ]; then
            echo "PAGE_URL=${{ github.event.inputs.url }}" >> $GITHUB_ENV
          else
            case "${{ env.ENVIRONMENT }}" in
              development)
                echo "PAGE_URL=https://dev.cargoro.com" >> $GITHUB_ENV
                ;;
              staging)
                echo "PAGE_URL=https://staging.cargoro.com" >> $GITHUB_ENV
                ;;
              production)
                echo "PAGE_URL=https://cargoro.com" >> $GITHUB_ENV
                ;;
            esac
          fi
          
          echo "μ›Ήνμ΄μ§€ ν…μ¤νΈ URL: $PAGE_URL"
      
      - name: WebPageTest μ‹¤ν–‰
        if: ${{ env.WPT_API_KEY != '' }}
        run: |
          npx webpagetest test $PAGE_URL \
            --key ${{ env.WPT_API_KEY }} \
            --location 'ec2-ap-northeast-2:Chrome' \
            --connectivity '4G' \
            --runs 3 \
            --first \
            --specs infra/performance/webpagetest-specs.json \
            --reporter json \
            > webpagetest-results.json
        env:
          WPT_API_KEY: ${{ secrets.WPT_API_KEY }}
      
      - name: κ²°κ³Ό μ €μ¥
        if: ${{ env.WPT_API_KEY != '' }}
        uses: actions/upload-artifact@v3
        with:
          name: webpagetest-results
          path: webpagetest-results.json
          retention-days: 30
      
      - name: WebPageTest κ²°κ³Ό μƒλµ (API ν‚¤ μ—†μ)
        if: ${{ env.WPT_API_KEY == '' }}
        run: |
          echo "WebPageTest API ν‚¤κ°€ μ„¤μ •λμ§€ μ•μ•„ ν…μ¤νΈλ¥Ό κ±΄λ„λλ‹λ‹¤."

  report:
    name: μ„±λ¥ λ³΄κ³ μ„ μƒμ„±
    needs: [lighthouse-test, k6-load-test, webpagetest]
    runs-on: ubuntu-latest
    steps:
      - name: ν…μ¤νΈ κ²°κ³Ό λ‹¤μ΄λ΅λ“
        uses: actions/download-artifact@v3
        with:
          path: performance-results
      
      - name: λ¨λ“  ν…μ¤νΈ κ²°κ³Ό μ”μ•½
        run: |
          echo "# π€ μ„±λ¥ ν…μ¤νΈ κ²°κ³Ό μ”μ•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## π ν…μ¤νΈ ν™κ²½: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## π“ Lighthouse μ„±λ¥ μ μ" >> $GITHUB_STEP_SUMMARY
          if [ -f "performance-results/lighthouse-results/manifest.json" ]; then
            MANIFEST=$(cat performance-results/lighthouse-results/manifest.json)
            REPORT_PATH=$(echo $MANIFEST | jq -r '.[(length-1)].jsonPath')
            REPORT=$(cat "performance-results/lighthouse-results/$REPORT_PATH")
            
            PERF_SCORE=$(echo $REPORT | jq '.categories.performance.score * 100')
            LCP_VALUE=$(echo $REPORT | jq '.audits["largest-contentful-paint"].numericValue / 1000')
            TTI_VALUE=$(echo $REPORT | jq '.audits["interactive"].numericValue / 1000')
            
            echo "| λ©”νΈλ¦­ | κ°’ | λ©ν‘ |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
            echo "| μ„±λ¥ μ μ | $PERF_SCORE | β‰¥90 |" >> $GITHUB_STEP_SUMMARY
            echo "| μµλ€ μ½ν…μΈ ν’€ νμΈνΈ (LCP) | $(printf "%.2f" $LCP_VALUE) μ΄ | <2.5μ΄ |" >> $GITHUB_STEP_SUMMARY
            echo "| μƒνΈμ‘μ© κ°€λ¥ μ‹κ°„ (TTI) | $(printf "%.2f" $TTI_VALUE) μ΄ | <3.8μ΄ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "β Lighthouse κ²°κ³Όλ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # μ¬λ™ λ©”μ‹μ§€ μ „μ†΅
          if [ -n "${{ env.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "μ„±λ¥ ν…μ¤νΈ κ²°κ³Ό (${{ env.ENVIRONMENT }})"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Lighthouse μ„±λ¥ μ μ:* '$PERF_SCORE'μ \n*μμ„Έν• κ²°κ³Ό:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }' ${{ env.SLACK_WEBHOOK_URL }}
          fi 