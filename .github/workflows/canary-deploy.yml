name: Canary ë°°í¬

on:
  workflow_dispatch:
    inputs:
      percentage:
        description: 'íŠ¸ë˜í”½ ë¹„ìœ¨ (%)'
        required: true
        default: '10'
        type: choice
        options:
          - '5'
          - '10'
          - '20'
          - '50'
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  REGISTRY_USERNAME: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
  KUBECONFIG: ${{ secrets.KUBECONFIG }}
  CANARY_PERCENTAGE: ${{ github.event.inputs.percentage }}

jobs:
  build-and-push:
    name: ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tags: ${{ steps.meta.outputs.tags }}
    strategy:
      matrix:
        service: [api-gateway, worker]
        include:
          - service: api-gateway
            context: ./backend/gateway
            dockerfile: ./infra/docker/api-gateway/Dockerfile
          - service: worker
            context: ./backend/jobs
            dockerfile: ./infra/docker/worker/Dockerfile
    
    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v2

      - name: ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¤€ë¹„
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}-canary
          tags: |
            type=sha,format=long
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v4
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-canary:
    name: ${{ github.event.inputs.environment }} í™˜ê²½ì— Canary ë°°í¬
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
    
    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: kubeconfig ì„¤ì •
        run: |
          mkdir -p $HOME/.kube
          echo "${{ env.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Helm ì„¤ì¹˜
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: kubectl ì„¤ì¹˜
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: ë°°í¬ í™˜ê²½ í™•ì¸
        id: deployment-env
        run: |
          ENV=${{ github.event.inputs.environment }}
          echo "í™˜ê²½: $ENV"
          echo "ENV=$ENV" >> $GITHUB_ENV
          
      - name: Canary ë°°í¬ ì‹¤í–‰
        run: |
          ENV=${{ env.ENV }}
          
          # values íŒŒì¼ ì„ íƒ
          VALUES_FILE="infra/k8s/values-${ENV}-canary.yaml"
          if [ ! -f "$VALUES_FILE" ]; then
            VALUES_FILE="infra/k8s/values-canary.yaml"
            echo "í™˜ê²½ë³„ canary values íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ values-canary.yaml ì‚¬ìš©"
          fi
          
          # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸ ë° ìƒì„±
          NAMESPACE="cargoro-${ENV}"
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -
          
          # ì´ë¯¸ì§€ íƒœê·¸ ê°€ì ¸ì˜¤ê¸° (SHA ê¸°ì¤€)
          API_GATEWAY_TAG=$(echo '${{ needs.build-and-push.outputs.image_tags }}' | grep -o "${{ env.REGISTRY }}/${{ github.repository }}/api-gateway-canary@sha256:[a-f0-9]*" | head -1)
          WORKER_TAG=$(echo '${{ needs.build-and-push.outputs.image_tags }}' | grep -o "${{ env.REGISTRY }}/${{ github.repository }}/worker-canary@sha256:[a-f0-9]*" | head -1)
          
          # Canary ë°°í¬ ìƒì„±/ì—…ë°ì´íŠ¸
          helm upgrade --install cargoro-${ENV}-canary ./infra/k8s \
            --namespace $NAMESPACE \
            --values $VALUES_FILE \
            --set apiGateway.image=$API_GATEWAY_TAG \
            --set worker.image=$WORKER_TAG \
            --set global.environment=$ENV \
            --set canary.enabled=true \
            --set canary.trafficPercentage=${{ env.CANARY_PERCENTAGE }}
          
          echo "Canary ë°°í¬ ì™„ë£Œ: $NAMESPACE ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ cargoro-${ENV}-canary ë¦´ë¦¬ìŠ¤ (íŠ¸ë˜í”½ ${{ env.CANARY_PERCENTAGE }}%)"

  monitor-canary:
    name: Canary ëª¨ë‹ˆí„°ë§
    needs: deploy-canary
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
    
    steps:
      - name: kubeconfig ì„¤ì •
        run: |
          mkdir -p $HOME/.kube
          echo "${{ env.KUBECONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: kubectl ì„¤ì¹˜
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Canary ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          ENV=${{ github.event.inputs.environment }}
          NAMESPACE="cargoro-${ENV}"
          
          echo "Canary API ê²Œì´íŠ¸ì›¨ì´ ë°°í¬ ìƒíƒœ"
          kubectl rollout status deployment/api-gateway-canary -n $NAMESPACE
          
          echo "Canary ì›Œì»¤ ë°°í¬ ìƒíƒœ"
          kubectl rollout status deployment/worker-canary -n $NAMESPACE
          
          echo "Canary ì„œë¹„ìŠ¤ ìƒíƒœ"
          kubectl get all -n $NAMESPACE -l app.kubernetes.io/name=cargoro-canary
      
      - name: Slack ì•Œë¦¼ (ì„ íƒ ì‚¬í•­)
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          MATRIX_CONTEXT: ${{ toJson(matrix) }}
          
      - name: Canary ëª¨ë‹ˆí„°ë§ ì•ˆë‚´
        run: |
          echo "ğŸ” Canary ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œì—ì„œ ì„±ëŠ¥ ë° ì˜¤ë¥˜ìœ¨ì„ í™•ì¸í•˜ì„¸ìš”."
          echo "- Grafana: https://grafana.cargoro.com/d/canary-monitoring"
          echo "- Prometheus: https://prometheus.cargoro.com"
          echo ""
          echo "Canary ë°°í¬ë¥¼ í”„ë¡œë•ì…˜ìœ¼ë¡œ ìŠ¹ê²©í•˜ë ¤ë©´ 'promote-canary' ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
          echo "ë¬¸ì œê°€ ìˆìœ¼ë©´ 'rollback-canary' ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•˜ì—¬ ë¡¤ë°±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." 