# CarGoro 시스템 아키텍처

## 개요

CarGoro는 자동차 관련 종합 서비스를 제공하는 플랫폼으로, 다양한 사용자 역할(정비소, 탁송 기사, 법인 차량 관리자, 부품 관리자, 시스템 관리자)을 지원합니다. 본 문서는 CarGoro 시스템의 아키텍처를 설명합니다.

## 시스템 구성 요소

### 1. 프론트엔드 애플리케이션

CarGoro는 다양한 사용자 역할별로 최적화된 웹/모바일 애플리케이션을 제공합니다:

- **정비소 웹 (workshop-web)**: 정비소 관리자용 웹 애플리케이션
- **정비소 모바일 (workshop-mobile)**: 정비사용 모바일 애플리케이션
- **탁송 기사 앱 (delivery-driver)**: 탁송 기사용 모바일 애플리케이션
- **스마트카 앱 (smart-car-assistant)**: 차주용 스마트카 관리 앱
- **법인차량 관리 웹 (fleet-manager-web)**: 법인 차량 관리자용 웹 애플리케이션
- **부품 관리 웹 (parts-web)**: 부품 관리자용 웹 애플리케이션
- **관리자 웹 (superadmin-web)**: 시스템 관리자용 웹 애플리케이션

각 애플리케이션은 Next.js의 App Router를 기반으로 하며, ShadCN UI 컴포넌트와 Tailwind CSS를 활용합니다. 상태 관리에는 Zustand를 사용하고, API 호출에는 React Query를 사용합니다.

### 2. 백엔드 서비스

백엔드는 마이크로서비스 아키텍처로 구성되어 있으며, 각 서비스는 특정 도메인을, FastAPI를 기반으로 구현되어 있습니다:

- **게이트웨이 (gateway)**: GraphQL 기반 API 게이트웨이, 인증 및 권한 관리
  - 포트 충돌 방지를 위한 자동 포트 할당 기능 구현
  - 내장된 http 모듈을 사용한 경량 서버 (Kubernetes 환경용)
- **코어 API (core-api)**: 사용자, 인증, 권한 관리
- **정비 API (repair-api)**: 정비소, 작업, 예약 관리
- **탁송 API (delivery-api)**: 탁송, 배차, 위치 추적
- **부품 API (parts-api)**: 부품, 재고, 주문 관리
- **법인 API (fleet-api)**: 법인 차량, 계약, 정책 관리
- **관리자 API (admin-api)**: 시스템 관리, 모니터링, 분석

각 서비스는 자체 데이터베이스를 가질 수 있으며, 필요한 경우 서비스간 통신은 비동기 메시징(RabbitMQ)을 통해 이루어집니다.

### 3. 백그라운드 작업

일부 작업은 백그라운드에서 비동기적으로 처리됩니다:

- **작업 스케줄러 (jobs)**:
  - 개발 환경에서 'localhost' 및 프로덕션에서 'rabbitmq' 호스트 설정 자동 감지
  - 연결 실패 시 자동 재시도 메커니즘 구현
  - 개발 환경에서 RabbitMQ가 없는 경우에도 정상 작동하는 graceful fallback
- **알림 서비스**: 푸시, 이메일, SMS 알림 처리
- **분석 처리**: 데이터 집계 및 분석 처리

### 4. 데이터베이스

- **주 데이터베이스**: PostgreSQL
- **캐시**: Redis
- **검색 엔진**: Elasticsearch (선택적)

데이터베이스 액세스는 Drizzle ORM을 통해 이루어집니다.

## 시스템 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                      Client Applications                         │
│                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │
│  │Workshop  │  │Delivery  │  │Smart Car │  │Fleet Mgr │  │Parts Web │ │
│  │Web/Mobile│  │Driver App│  │Assistant │  │Web       │  │          │ │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘ │
└───────┼──────────────┼──────────────┼──────────────┼──────────────┼────┘
         │              │              │              │              │
         ▼              ▼              ▼              ▼              ▼
┌────────────────────────────────────────────────────────────────────────┐
│                                API Gateway                              │
│                         (GraphQL, Authentication)                       │
└───────┬──────────┬───────────┬────────────┬────────────┬───────────────┘
         │          │           │            │            │
         ▼          ▼           ▼            ▼            ▼
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│Core API  │  │Repair API│  │Delivery  │  │Fleet API │  │Parts API │
│(Users,   │  │(Workshop,│  │API       │  │(Fleet    │  │(Inventory│
│Auth)     │  │Services) │  │(Drivers) │  │Management)│  │Orders)   │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │             │
     └─────────────┼─────────────┼─────────────┼─────────────┘
                   │             │             │
                   ▼             ▼             ▼
         ┌───────────────────────────────────────────┐
         │              Message Broker               │
         │           (RabbitMQ, Redis PubSub)        │
         └─────────────────┬─────────────────────────┘
                           │
                           ▼
         ┌───────────────────────────────────────────┐
         │             Background Jobs               │
         │       (Celery, Analytics, Notifications)  │
         └─────────────────┬─────────────────────────┘
                           │
                           ▼
         ┌───────────────────────────────────────────┐
         │              Databases                    │
         │    (PostgreSQL, Redis, Elasticsearch)     │
         └───────────────────────────────────────────┘
```

## 배포 아키텍처

CarGoro는 Kubernetes 기반의 클라우드 환경에 배포됩니다:

- **컨테이너화**: 모든 서비스는 Docker 컨테이너로 패키징됩니다.
- **오케스트레이션**: Kubernetes를 사용하여 서비스를 관리합니다.
  - 개발/테스트 환경에서는 공용 표준 이미지(node:18-alpine) 활용 가능
  - 실제 서비스 이미지 사용이 불가능할 경우를 위한 대체 컨테이너 설정 관리
- **스케일링**: 수평적 자동 확장(HPA)을 통해 트래픽에 따라 자동으로 확장됩니다.
- **모니터링**: Prometheus, Grafana, Loki를 사용하여 모니터링합니다.
- **로깅**: 구조화된 JSON 로그를 통해 로깅하고 중앙 집중식 로그 관리를 제공합니다.
- **CI/CD**: GitHub Actions를 통한 지속적 통합 및 배포를 구현합니다.

### 로컬 Kubernetes 개발 환경

개발 목적으로 다음과 같은 설정이 구현되어 있습니다:

- API 게이트웨이 및 워커 서비스용 내장 http 서버 스크립트
- 이미지 풀 오류 방지를 위한 공개 접근 가능한 기본 이미지 설정
- 컨테이너 내부에서 실행 가능한 최소한의 코드 자동 생성

## 보안 아키텍처

- **인증**: Clerk를 사용한 사용자 인증
- **권한 부여**: RBAC(Role-Based Access Control) 시스템
- **API 보안**: JWT 기반 토큰 인증, API 키 관리
- **데이터 보안**: 전송 및 저장 데이터 암호화
- **로깅 및 감사**: 보안 이벤트 로깅 및 감사 추적

## 확장성 및 성능

- **캐싱**: API 응답 및 데이터베이스 쿼리 캐싱
- **CDN**: 정적 자산에 대한 CDN 활용
- **데이터베이스 최적화**: 인덱싱, 샤딩, 읽기 복제본
- **비동기 처리**: 시간이 많이 소요되는 작업의 비동기 처리

## 장애 대응 및 복원력

- **서비스 헬스 체크**: 모든 서비스에 대한 주기적인 헬스 체크
- **자동 복구**: 장애 감지 시 자동 복구 메커니즘
- **백업 및 복구**: 정기적인 데이터베이스 백업 및 복구 프로세스
- **재해 복구**: 다중 지역 배포를 통한 재해 복구 계획
- **연결 재시도 메커니즘**: 외부 서비스 연결 실패 시 자동 재시도 로직
